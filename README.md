Hivest API (OpenRouter-backed) — /analyze endpoint

Overview
- This service exposes a single public endpoint for portfolio analysis using an LLM via OpenRouter.
- Route: POST /analyze
- CORS: Enabled. The endpoint also responds to OPTIONS preflight requests.
- Default dev server: http://localhost:5000 (see app.run in api_openrouter.py)

Authentication and environment
- The /analyze endpoint itself does not require client authentication.
- The server requires these environment variables to call OpenRouter:
  - OPENROUTER_API_KEY (required): Your OpenRouter API key.
  - OPENROUTER_MODEL (optional): Defaults to meta-llama/llama-3.1-8b-instruct. Shorthand like "llama3:8b" is mapped to this default.
  - OPENROUTER_TIMEOUT (optional, int): Defaults to 180 seconds.
  - OPENROUTER_TEMPERATURE (optional, float): Defaults to 0.4.
  - OPENROUTER_SITE_URL (optional): Sent as HTTP-Referer header to OpenRouter.
  - OPENROUTER_APP_NAME (optional): Sent as X-Title header to OpenRouter.

Request format
- Method: POST
- Headers:
  - Content-Type: application/json
- Body JSON schema:
  {
    "portfolio": "<TICKER:WEIGHT> <TICKER:WEIGHT> ..."
  }

- The portfolio field is a single string containing one or more space-separated pairs in the form TICKER:WEIGHT.
  - TICKER: A valid stock/asset symbol (e.g., AAPL, MSFT, NVDA).
  - WEIGHT: A floating-point number (e.g., 0.5, 0.25, 1, etc.).
  - Pairs are separated by single spaces. Example: "AAPL:0.5 MSFT:0.3 NVDA:0.2".
  - Malformed pairs are ignored; if none are valid, the server returns HTTP 400.
  - Weights do not have to sum to 1, but providing reasonable weights is recommended.

Request examples
- curl
  curl -X POST "http://localhost:5000/analyze" \
       -H "Content-Type: application/json" \
       -d '{
             "portfolio": "AAPL:0.5 MSFT:0.3 NVDA:0.2"
           }'

- JavaScript (fetch)
  fetch("http://localhost:5000/analyze", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ portfolio: "AAPL:0.5 MSFT:0.3 NVDA:0.2" })
  })
    .then(r => r.json())
    .then(console.log)
    .catch(console.error);

- Python (requests)
  import requests

  url = "http://localhost:5000/analyze"
  payload = {"portfolio": "AAPL:0.5 MSFT:0.3 NVDA:0.2"}
  r = requests.post(url, json=payload)
  print(r.status_code)
  print(r.json())

Response format
- Success (HTTP 200)
  {
    "analysis": "<string with the natural-language portfolio analysis>"
  }
  Notes:
  - analysis is a string generated by the LLM based on computed metrics and recent news.

- Client error — invalid/missing JSON or portfolio (HTTP 400)
  {
    "error": "Content-Type must be application/json. Provide the 'portfolio' field in the JSON body.",
    "example": { "portfolio": "AAPL:0.5 MSFT:0.3" }
  }
  Or if no valid pairs are found after parsing:
  {
    "error": "No valid holdings were found. Please ensure the format is 'TICKER:WEIGHT'."
  }

- Server error (HTTP 500)
  {
    "error": "An internal server error occurred during analysis."
  }

Validation behavior (derived from api_openrouter.py)
- The server expects request.is_json.
- The portfolio value must be a non-empty string.
- Parsing splits on spaces; each token must match TICKER:WEIGHT where WEIGHT is castable to float.
- Invalid tokens are skipped; if none remain, a 400 is returned.

Operational notes
- Preflight: The endpoint responds to OPTIONS with {"success": true}.
- Timeframe: Internally uses a default timeframe label of "ytd" for analysis.
- News: By default, includes news in analysis (limit 6).
- LLM: The server uses OpenRouter; a default model analogous to "llama3:8b" is used if none is specified.

Troubleshooting
- 400 errors: Verify Content-Type and the portfolio string format.
- 500 errors: Check server logs and ensure OPENROUTER_API_KEY is set and valid; network access to openrouter.ai must be available.
